branches:
  only:
    - master


os: Visual Studio 2017
version: "{branch}-{build}"

clone_folder: c:\build

environment:
  MYCI_BINTRAY_API_KEY:
    secure: t04W/09OyK0B8CxJHydCkay+Fm3i6KkBciVXjzk0u09v6F9wtDn/dsuqd5eMIj8s

install:
  - C:\msys64\usr\bin\bash -lc "echo -e '[igagis_msys]\\nSigLevel = Optional TrustAll\\nServer = https://dl.bintray.com/igagis/msys2/msys/' >> /etc/pacman.conf"
  - C:\msys64\usr\bin\pacman -Sy --noconfirm myci

before_build:


build_script:
  - C:\msys64\usr\bin\bash -lc "cd /c/build/ && myci-apply-version.sh -v `myci-deb-version.sh debian/changelog` msys2/PKGBUILD.in"
  - C:\msys64\usr\bin\bash -lc "cd /c/build/msys2 && makepkg --skipinteg"

test_script:
  #pacman package build already performs tests

deploy_script:
  - cmd: if "%APPVEYOR_REPO_TAG%"=="true" (
              C:\msys64\usr\bin\bash -lc "cd /c/build && myci-deploy-pacman-bintray.sh -u igagis -r msys2 -p msys -d igagis_msys msys2/*.pkg.tar.xz"
          ) else (
              echo Skipping deploy because not a tagged commit.
          )

artifacts:
  - path: msys2/*.pkg.tar.xz
